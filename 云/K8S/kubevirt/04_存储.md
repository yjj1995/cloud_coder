

## KubeVirt 虚机的磁盘和卷

- KubeVirt使用VirtualMachine类型的CRD用来描述一个VM，其中在spec.volumes部分定义了VM使用的卷，在`spec.domain.devices.disks`部分定义了vm使用的磁盘，另外卷的名称必须和磁盘的名称保持一样。
- KubeVirt 支持多种存储插件和方案，让用户可以根据不同的需求，为虚拟机提供合适的存储空间和配置。KubeVirt 的存储解决方案主要包括以下几种：
  1. **ephemeral** - 其对应的卷 (PVC) 的数据不会以发生变化，因为所有的写入都保存在位于本地存储的临时镜像中。当 VM 停止、重启或删除时，便会丢弃临时镜像。
  1. **containerDisk** - 从 registry 中拉取镜像到运行 VM 的主机节点上，并在 VM 启动时作为磁盘附加到 VM。containerDisk 提供了在容器镜像注册表中存储和分发 VM 磁盘的能力。不过 **containerDisk 是临时的，数据将在 VM 停止、重启或删除时丢弃。**
  1. *dataVolume** - 可动态创建 PVC 并将外部磁盘、镜像、容器数据导入到这些 PVC 中。为了使用 dataVolume 卷，必须借助 OpenShift Virtualization Operator 安装的 **Containerized Data Importer (CDI)** 功能。如果不使用 dataVolume 卷，那么可以使用 persistentVolumeClaim 卷，即将一个可用的 PVC 分配给 VM。
  1. **persistentVolumeClaim** - 将可用的 PVC 附加到 VM。将现有 VM 导入到 OpenShift 中的方法是使用 CDI 将现有 VM 的磁盘或容器镜像中的磁盘导入到 PVC 中，然后将 PVC 附加到 VM 实例。
  1. **emptyDisk** - 为 VM 创建额外的 qcow2 磁盘。当 VM 重启，数据会保留下来，但当重新创建 VM，数据将会被丢弃。
  1. **cloudInitNoCloud** - 将所引用的 cloudInitNoCloud 数据源附加给磁盘，以便在 VM 启动后自动执行脚本。VM 内部需要安装 cloud-init。

- containerDisk 卷必须对应容器镜像，而dataVolume卷可以对应容器镜像。
- 如果需要用 containerDisk 和 dataVolume 对应的磁盘启动 VM，需要将 qcow2 封装到容器镜像中。



> 参考
>
> [OpenShift 4 - KubeVirt 虚机使用的磁盘和卷_openshift pvc-CSDN博客](https://blog.csdn.net/weixin_43902588/article/details/129966887)
